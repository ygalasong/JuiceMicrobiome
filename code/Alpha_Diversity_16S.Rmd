---
title: "Alpha_Diversity_16S"
author: "Yupawadee Galasong"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Load packages
```{r}
pacman::p_load(phyloseq, iNEXT, tidyverse, ggpubr, install = FALSE)
```

### Load color and shape preferences
```{r}
source(file = "code/colors.R")

```
### Biodiversity Analysis
```{r}
# Create ASV data frame as an input for iNEXT
iNEXT_input <- as.data.frame(final_physeq@otu_table)

# For reproducibility
set.seed(777)

# Calculate Hill numbers
#q = 0 means total number of taxa ("Effective number of species")
#q = 1 means Number of common taxa (equivalent to exp(Shanon))
#q = 2 means Number of dominant taxa (inverse Simpson)

#iNEXT_output <- iNEXT(iNEXT_input, q = c(0,1,2), datatype = "abundance")
save(iNEXT_output, file = "Data_16S/iNEXT_output.RData")
```

#### Export iNEXT output as a dataframe suitable for plotting 
```{r}
# Creating a data frame containing diversity measures from iNEXT output
# plus metadata
metadata <- final_physeq@sam_data %>% data.frame() %>%
  rownames_to_column(var = "Assemblage") %>%
  # Add another grouping variable - Thermal Vs Non-thermal Vs No Treatment
    mutate(Thermal = case_when(
    (Treatment == "Pasteurization")~"Thermal",
    (Treatment == "HPP")~"Non-thermal",
    (Treatment == "HPP + DMDC + NG")~"Non-thermal",
    (Treatment == "Pasteurization + DMDC + NG")~"Thermal",
    (Treatment == "Pasteurization + SB + PS")~"Thermal",
    (Treatment == "UV")~"Non-thermal",
    (Treatment == "No Treatment")~"No Treatment"))

div_iNEXT <- iNEXT_output$AsyEst %>%
  left_join(., metadata, by = "Assemblage") %>% 
  # Change diversity measures to factor for plotting
  mutate(Diversity = as.factor(Diversity))
```
#### Species richness over shelf-life
```{r}
RichnessPlot1 <- div_iNEXT %>% filter(Diversity == "Species richness") %>%
  ggplot(aes(x = Shelf_Life_Stage, y = Observed))+
  geom_point(aes(shape = Beverage, color = Treatment), size = 2, alpha = 0.75)+
  scale_shape_manual(values = Beverage_shape)+
  scale_color_manual(values = Treatment_color)+
  theme_classic() + labs(x = "Stage in Shelf-life", y = "Species Richness")+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12))

RichnessPlot2 <- div_iNEXT %>% filter(Diversity == "Species richness") %>%
  ggplot(aes(x = Day, y = Observed))+
  geom_point(aes(shape = Beverage, color = Treatment), size = 2, alpha = 0.75)+
  scale_shape_manual(values = Beverage_shape)+
  scale_color_manual(values = Treatment_color)+
  theme_classic() + labs(x = "Time (Days)", y = "Species Richness")+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12))
RichnessPlot1
RichnessPlot2
```
#### Rarefaction curve
```{r}
# 1. Extract the observed richness from iNEXT output
obs_rich <- iNEXT_output$iNextEst$size_based %>%
  dplyr::filter(Order.q == 0) %>%
  dplyr::filter(Method == "Observed") %>%
  # Include sample metadata
  left_join(., metadata, by = "Assemblage") 
  

rarefaction_curve <- 
  # 2. Extract richness calculated from rarefied samples
  iNEXT_output$iNextEst$size_based %>% 
  dplyr::filter(Order.q == 0) %>%
  dplyr::filter(Method == "Rarefaction")%>%
  # Include sample metadata
  left_join(., metadata, by = "Assemblage") %>% 
  # 3. Plot rarefaction curve
  ggplot(aes(x = m/1000, y = qD, color = Treatment, group = Assemblage))+
  scale_color_manual(values = Treatment_color) + 
  geom_line()+ geom_point(data = obs_rich, 
             aes(x = m/1000, y = qD, color = Treatment))+
  facet_grid(.~Beverage)+theme_classic()+
  labs(x = "Number of Sequences (x1000)", y = "Species Richness")

ggsave(filename = "Figure/rarefaction_curve_16S.png", plot =  rarefaction_curve, device = "png",
       height = 3, width = 6, units = "in")

```

### Diversity boxplot
```{r}
# Diversity in orange juice
obs_rich %>%
  dplyr::filter(Beverage == "Orange Juice") %>%
  ggplot(aes(x = Thermal, y = qD, color = Thermal))+
  geom_boxplot(aes(fill = Thermal), alpha = 0.5)+
  scale_fill_manual(values = Thermal_color)+
  scale_color_manual(values = Thermal_color)+
  geom_jitter(size = 2.5, alpha = 0.75)+
  theme_classic()+labs(x = "Treatment", y = "Species richness")+
  facet_grid(.~Shelf_Life_Stage)+
  theme(axis.text.x = element_text(angle = 45))

oj_richness <- obs_rich %>%
  filter(Beverage == "Orange Juice") %>%
  ggplot(aes(x = Spoilage, y = qD, fill = Spoilage))+
  geom_boxplot(alpha = 0.75, outlier.shape = NA)+ 
  guides(fill = "none")+
  scale_fill_manual(values = Spoiled_color)+
  guides(fill = FALSE)+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  labs(y = "Species richness")+
  facet_grid(.~Thermal)+ 
  stat_kruskal_test(label.y = 200)+
  theme_pubr()

# Diversity in cider
obs_rich %>%
  dplyr::filter(Beverage == "Cider") %>%
  ggplot(aes(x = Thermal, y = qD, color = Thermal))+
  geom_boxplot(aes(fill = Thermal), alpha = 0.5)+
  scale_fill_manual(values = Thermal_color)+
  scale_color_manual(values = Thermal_color)+
  geom_jitter(size = 2.5, alpha = 0.75)+
  theme_classic()+labs(x = "Treatment", y = "Species richness")+
  facet_grid(.~Shelf_Life_Stage)+
  theme(axis.text.x = element_text(angle = 45))

# This boxplot shows that species richness is not significantly affected at the 
# end of shelf-life for thermally and non-thermally treated ciders.
obs_rich %>%
  dplyr::filter(Beverage == "Cider") %>%
  ggplot(aes(x = Shelf_Life_Stage, y = qD, color = Shelf_Life_Stage))+
  geom_boxplot(aes(fill = Shelf_Life_Stage), alpha = 0.5)+
  scale_fill_manual(values = Stage_color)+
  scale_color_manual(values = Stage_color)+
  geom_jitter(size = 2.5, alpha = 0.75)+
  theme_classic()+labs(x = "Stage of Shelf-life", y = "Species richness")+
  facet_grid(.~Thermal)+ stat_kruskal_test()+
  theme(axis.text.x = element_text(angle = 45))
# This boxplot shows that species richness is not significantly affected at the 
# end of shelf-life for untreated and treated orange juices...
obs_rich %>%
  dplyr::filter(Beverage == "Orange Juice") %>%
  ggplot(aes(x = Shelf_Life_Stage, y = qD, color = Shelf_Life_Stage))+
  geom_boxplot(aes(fill = Shelf_Life_Stage), alpha = 0.75)+
  scale_fill_manual(values = Stage_color)+
  scale_color_manual(values = Stage_color)+
  geom_jitter(size = 2.5, alpha = 0.5)+
  theme_classic()+labs(x = "Stage of Shelf-life", y = "Species richness")+
  facet_grid(.~Thermal)+ stat_kruskal_test()+
  theme(axis.text.x = element_text(angle = 45))

cd_richness <- obs_rich %>%
  filter(Beverage == "Cider") %>%
  ggplot(aes(x = Spoilage, y = qD, fill = Spoilage))+
  geom_boxplot(alpha = 0.75, outlier.shape = NA)+ 
  guides(fill = "none")+
  scale_fill_manual(values = Spoiled_color)+
  guides(fill = FALSE)+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  labs(y = "Species richness")+
  facet_grid(.~Thermal)+ 
  stat_kruskal_test(label.y = 300)+
  theme_pubr()
```

### Shannon index for species evenness
```{r}
oj_shannon <- div_iNEXT %>% 
  filter(Diversity == "Shannon diversity", 
         Beverage == "Orange Juice") %>% 
  ggplot(aes(x = Spoilage, y = Observed, fill = Spoilage))+
  geom_boxplot(alpha = 0.75) + 
  guides(fill = "none")+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  scale_fill_manual(values = Spoiled_color)+
  labs(y = "Shannon diversity")+
  facet_grid(.~Thermal)+ 
  stat_kruskal_test(label.y = 50)+
  theme_pubr()

cd_shannon <- div_iNEXT %>% 
  filter(Diversity == "Shannon diversity", 
         Beverage == "Cider") %>% 
  ggplot(aes(x = Spoilage, y = Observed, fill = Spoilage))+
  geom_boxplot(alpha = 0.75) + 
  guides(fill = "none")+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  scale_fill_manual(values = Spoiled_color)+
  labs(y = "Shannon diversity")+
  facet_grid(.~Thermal)+
  stat_kruskal_test(label.y = 75)+
  theme_pubr()
```
### Simpson diversity measuring the abundant/dominant taxa
```{r}
 oj_simpson <- div_iNEXT %>% 
  filter(Diversity == "Shannon diversity", 
         Beverage == "Orange Juice") %>% 
  ggplot(aes(x = Spoilage, y = Observed, fill = Spoilage))+
  geom_boxplot(alpha = 0.75) + 
  guides(fill = "none")+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  scale_fill_manual(values = Spoiled_color)+
  labs(y = "Simpson diversity")+
  facet_grid(.~Thermal)+ 
  stat_kruskal_test(label.y = 45)+
  theme_pubr()

cd_simpson <- div_iNEXT %>% 
  filter(Diversity == "Simpson diversity", 
         Beverage == "Cider") %>% 
  ggplot(aes(x = Spoilage, y = Observed, fill = Spoilage))+
  geom_boxplot(alpha = 0.75) + 
  guides(fill = "none")+
  geom_jitter(aes(color = Treatment),size = 2.5)+
  scale_color_manual(values = Treatment_color)+
  scale_fill_manual(values = Spoiled_color)+
  labs(y = "Simpson diversity")+
  facet_grid(.~Thermal)+
  stat_kruskal_test(label.y = 45)+
  theme_pubr()

```
### Combining Shannon and Simpson Diversity Plots
Tip: changing "binwidth" value in geom_dotplot also changes dot size.
```{r}
ggpubr::ggarrange(oj_richness, oj_shannon, oj_simpson,
                  ncol = 1, nrow = 3, common.legend = TRUE, 
                  labels = c("A", "B", "C"),
                  legend = "bottom")
ggsave(filename = "Figure/alpha_16S_oj.png", device = "png", height = 5, width = 7, units = "in")

ggpubr::ggarrange(cd_richness, cd_shannon, cd_simpson,
                  ncol = 1, nrow = 3, common.legend = TRUE,
                  labels = c("A","B","C"),
                  legend = "bottom")
ggsave(filename = "Figure/alpha_16S_cd.png", device = "png", height = 5, width = 7, units = "in")

```
##### Session information
```{r}
devtools::session_info()
```
---
title: "Beta_Diversity_ITS"
author: "Yupawadee Galasong"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

### Load packages

```{r}
pacman::p_load(phyloseq, tidyverse, ggpubr, ggforce, tempted, install = FALSE)
```

### Set up color & shape preferences - Metadata variables

Useful palette generator <https://coolors.co/> Make sure it is friendly
to color blind readers.
<https://www.datylon.com/blog/data-visualization-for-colorblind-readers#:~:text=The%20first%20rule%20of%20making,out%20of%20these%20two%20hues.>
Example of how to use color and shape preferences in ggplot
`ggplot(data = final_physeq@sam_data, aes(x = malic, y = fructose))+geom_point(aes(color = Trial, shape = Trial))+scale_color_manual(values = Trial_color)+scale_shape_manual(values = Trial_shape)`

```{r}
# Specify colors
Trial_color <- c("#fcd0a1","#b1b695","#A690A4")
# Specify which trial each color is for
names(Trial_color) <- c(1,2,3)

Trial_shape <- c(15,16,17)
names(Trial_shape) <- c(1,2,3)

Beverage_color <- c("#FFC759","#FF7B9C")
names(Beverage_color) <- c("Orange Juice","Cider")

Beverage_shape <- c(18,19)
names(Beverage_shape) <- c("Orange Juice","Cider")

Treatment_color <- c("#332288", "#882255", "#AA4499", "#CC6677", "#DDCC77", 
                     "#44AA99", "#117733")
names(Treatment_color) <- c("No Treatment", "Pasteurization", 
                           "Pasteurization + SB + PS","Pasteurization + DMDC + NG",
                           "UV","HPP","HPP + DMDC + NG")
Stage_color <- c("#aec5eb", "#3D65A5", "#1F449C")
names(Stage_color) <- c("Beginning", "Day14", "End")

Stage_shape <- c(15,16,17)
names(Stage_shape) <- c("Beginning", "Day14", "End")

Spoiled_color <- c("#FFEAD0", "#F76F8E")
names(Spoiled_color) <- c("Not spoiled", "Spoiled")

Thermal_color <- c("#EB4511","#1C3144","#FFBA08")
names(Thermal_color) <- c("Thermal", "Non-thermal", "No Treatment")

Tech_color <- c("#82D173","#16697A","#F5B700")
names(Tech_color) <- c("HPP","Pasteurization","Untreated & UV")
```

## Microbiome data is compositional.

1.  Microbiome Datasets Are Compositional: And This Is Not Optional
    <https://doi.org/10.3389/fmicb.2017.02224>
2.  A Novel Sparse Compositional Technique Reveals Microbial
    Perturbations (robust Aitchison PCA)
    <https://doi.org/10.1128/msystems.00016-19>
3.  Time-Informed Dimensionality Reduction for Longitudinal Microbiome
    Studies <https://doi.org/10.1101/2023.07.26.550749>

### Computational approach for compositional data

Note: the code in the next four chunks won't be run. It is only for
showing the workflow using popular packages. For this project, we will
use a rather novel method implemented in `tempted` package. 

#### Imputation of zeros, left-censored and missing data in compositional
data

```{r}
#zCompostionsR::

```

#### Centered log-ration (CLR) transformation

```{r}
#clr <- microbiome::transform(final_physeq, "clr")
#otu_table(clr)[1:5,1:5]
```

#### Aitchison distance

Aitchison distance is basically the Euclidean distances between
CLR-transformed sample abundance vectors.

```{r}
#aitchison <- vegan::vegdist(clr, method = "euclidean")

# Are results the same?
#aitchison2 <- phyloseq::distance(clr, method = "euclidean")
```

#### Variance-based compositional principal component analysis (PCA)

```{r}
## while the method is specified as rda (short for Redundancy Analysis),
## not specifying the 'formula' argument means we are running an unconstrained RDA,
## which is equivalent to running PCA.
# pca_clr <- phyloseq::ordinate(clr, method = "RDA", distance = aitchison2)
```

### TEMPoral TEnsor Decomposition (TEMPTED)

The goal of TEMPTED is to perform dimensionality reduction for
multivariate longitudinal data, with a special attention to longitudinal
microbiome studies.

#### Load the data and modify to the format required by 'tempted' package

```{r}
load("/local/workdir/yg225/JuiceMicrobiome/Data_ITS/metadata.RData")
#load("/local/workdir/yg225/JuiceMicrobiome/Data_ITS/final_physeq.RData")
load("/local/workdir/yg225/JuiceMicrobiome/Data_ITS/PERFect_physeq.RData")
# A data.frame with rows representing samples and matching with data.frame count table and processed table
## Create a unique ID for each (juice, treatment) combination
ID_df <- metadata %>% expand(Beverage, Treatment, Trial) %>% 
  mutate(JuiceID = seq(from = 1, to = nrow(.)))

metatable <- metadata %>% 
  # remove irrelevant columns
  dplyr::select(-c("is.neg","Sample_or_Control")) %>% 
  # Assign JuiceID to each entry
  left_join(., y = ID_df,) %>%
  # Change row names to sample names
  column_to_rownames(var = "Assemblage") %>%
  mutate(Tech = case_when(
  Treatment == "Pasteurization" |
    Treatment == "Pasteurization + DMDC + NG" |
    Treatment == "Pasteurization + SB + PS" ~ "Pasteurization",
  Treatment == "HPP" | 
    Treatment == "HPP + DMDC + NG" ~ "HPP",
  .default = "Untreated & UV")) %>% mutate (Tech = as.factor(Tech))



# A data.frame with rows representing samples and matching with data.frame metatable and columns representing microbial features (i.e. OTUs). Each entry is a read count.

counttable <- PERFect_physeq@otu_table %>% t() %>% as.data.frame() 

zero <- which(rowSums(counttable) == 0)

counttable <- counttable[-zero, ]

# Remove sample with zero reads left after cleaning up with PERFect
metatable <- metatable[-zero, ]
# Check if rows match and display the number of matches which should equal the number of samples
table(rownames(counttable) == rownames(metatable))

# A variable storing ID and Treatment
metauni <- unique(metatable[,c("JuiceID","Beverage","Treatment","Trial","Thermal","Tech")])
```

#### Run TEMPTED for Microbiome Count Data

Following github tutorial
<https://github.com/pixushi/tempted?tab=readme-ov-file>

```{r}
# Remove subject with only 1 time point to avoid error
# An error earlier indicated that JuiceID 25 and 28 must be removed

rm_ID <- which(table(metatable$JuiceID)<2)

# Remove JuiceID 25 and 28 from metatable
metatable <- metatable %>% filter(!(JuiceID %in% rm_ID))

# Remove JuiceID 25 and 28 from the count table
counttable <- counttable[rownames(metatable),]

# Check that sample names still match
table(rownames(counttable)==rownames(metatable))
```

### OJ data set

```{r}

metatable_oj <- metatable %>% filter(Beverage == "Orange Juice")

counttable_oj <- counttable[rownames(metatable[which(metatable$Beverage == "Orange Juice"),]),]

counttable_oj <- counttable[rownames(counttable) %in% rownames(metatable_oj),]


res_count_oj <- tempted::tempted_all(counttable_oj,
                                  metatable_oj$Day,
                                  metatable_oj$JuiceID,
                                  threshold = 0.95,
                                  transform = "clr",
                                  pseudo = 0.5,
                                  r = 3,
                                  smooth = 1e-5,
                                  pct_ratio = 0.1,
                                  pct_aggregate = 1)
#[output]
#Calculate the 1th Component
#Convergence reached at dif=6.7876739385886e-05, iter=4
#Calculate the 2th Component
#Convergence reached at 5.23296722720532e-05, iter=12
#Calculate the 3th Component
#Convergence reached at dif=7.43310004191861e-05, iter=15
```

#### Low-dimensional representation of SUBJECTS

```{r}
# Create a data frame for plotting samples on a 2D space

A_data_oj <- metauni %>% filter(Beverage == "Orange Juice" & JuiceID %in% metatable_oj$JuiceID)

rownames(A_data_oj) <- A_data_oj$JuiceID

# Subject loadings are stored in A_hat (stored in res_count)
A_data_oj <- cbind(res_count_oj$A_hat[rownames(A_data_oj),],A_data_oj)

# Plot of subject loading
p_oj <- A_data_oj %>% 
  ggplot(aes(x = A_data_oj$PC1, y = A_data_oj$PC2))+
  geom_point(aes(color = Trial, shape = Thermal), size = 4)+ 
  labs(x = "Component 1", y = "Component 2",
       title = "Subject loadings")+
  scale_color_manual(values = Trial_color)+ 
  geom_mark_ellipse(aes(fill = Trial), expand = unit(2, "mm"))+
scale_fill_manual(values = Trial_color)+
  scale_y_continuous(limits = c(-0.5,0.8))+
  #scale_x_continuous(limits = c(-0.4,0.6))+
  theme_pubr(legend = "right")
```

Clearly, the beta diversity is driven by Trial, i.e. the source of the juice.We can also kind of see that samples form thermal VS non-thermal cluster. The 'no treatment' cluster very much overlap with the non-thermal cluster. See the plot below.

```{r}
# Plot of subject loading
p_oj2 <- A_data_oj %>% ggplot(aes(x = A_data_oj$PC1, y = A_data_oj$PC2))+
  geom_point(aes(color = Thermal, shape = Trial), size = 4)+ 
  labs(x = "Component 1", 
       y = "Component 2",
       title = "Subject loadings")+
  scale_color_manual(values = Thermal_color)+
  geom_mark_ellipse(aes(fill = Thermal), alpha = 0.15,
                          expand = unit(2, "mm"))+
  scale_fill_manual(values = Thermal_color)+
  scale_y_continuous(limits = c(-0.4,0.6))+
  scale_x_continuous(limits = c(-0.4,0.6))+
  theme_pubr(legend = "right")
  

```
# Beta-diversity plots with 'less information'
```{r}
p_oj_min1 <- A_data_oj %>% 
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = Trial), size = 4)+
  labs(x = "Component 1", y = "Component 2",
  title = "Subject loadings \n colored by Trial")+
  scale_color_manual(values = Trial_color)+
  theme_pubr()

p_oj_min2 <- A_data_oj %>% 
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = Thermal), size = 4)+
  labs(x = "Component 2", y = "Component 3",
  title = "Subject loadings \n colored by treatment")+
  scale_color_manual(values = Thermal_color)+
  theme_pubr()


p_oj_min3 <- A_data_oj %>%
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = Tech), size = 4)+
  labs( x = "Component 2",
        y = "Component 3",
        title = "Subject loadings \n colored by technology",
        color = "Technology")+
  scale_color_manual(values = Tech_color)+
  theme_pubr()

ggarrange(p_oj_min1, p_oj_min3, legend = "bottom")
```
# Plot of subject loading (component 2 & 3)
```{r}
p_oj3 <- A_data_oj %>% 
  ggplot(aes(x = A_data_oj$PC2, y = A_data_oj$PC3))+
  geom_point(aes(shape = Thermal, color = Treatment), 
             size = 4)+ labs(x = "Component 2", y = "Component 3",
                                     title = "Subject loadings")+
  scale_color_manual(values = Treatment_color)+ 
  geom_mark_ellipse(aes(fill = Trial), expand = unit(5, "mm"))+
scale_fill_manual(values = Trial_color)+
  scale_y_continuous(limits = c(-0.6,0.8))+
  scale_x_continuous(limits = c(-0.6,0.6))+
  theme_pubr()
```
#### Temporal loadings
Accent, Dark2, Paired, Pastel1, Pastel2, Set1, Set2, Set3
```{r}
# Temporal loadings are stored in Phi_hat in res_count
tempted::plot_time_loading(res_count_oj, r = 3)+
  geom_line(aes(color = component),
            linewidth = 2)+
  scale_color_brewer(palette = "Paired")+
  labs(title = "Temporal Loadings", x = "Time in shelf-life (Days)")+
  theme_pubr()

```

#### Feature (ASV) loadings

```{r}
# Feature loadings are stored in B_hat in res_count
res_count_oj$B_hat %>% as.data.frame() %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point() + 
  labs(x = "Component 1", y = "Component 2", title = "Feature loading")+
  theme_classic()

res_count_oj$B_hat %>% as.data.frame() %>%
  ggplot(aes(x = PC2, y = PC3))+
  geom_point() + 
  labs(x = "Component 2", y = "Component 3", title = "Feature loading")+
  theme_classic()

```

#### Log ratio of top features

```{r}
# Log ratios are stored in metafeature_ration in res_count
# For grouping variable, subset the JuiceID, a desired column
tempted::plot_metafeature(res_count_oj$metafeature_ratio, 
                          metauni[,c(1,6)],nrow = 2) + 
  geom_line()+
  xlab("Days in shelf-life")+theme_pubr()+
  scale_color_manual(values = Tech_color, name = "Treatment")+
  scale_fill_manual(values = Tech_color, name = "Treatment")

```

#### Subject trajectories

```{r}
# Subject trajectories are stored in metafeature_aggregate in res_count
tempted::plot_metafeature(res_count_oj$metafeature_aggregate, metauni[,c(1,3)],nrow = 1)+
  xlab("Days in shelf-life")+
  scale_fill_manual(values = Treatment_color, 
                    name = "Treatment")+
  scale_color_manual(values = Treatment_color, 
                     name = "Treatment")+
  theme_pubr(legend = "bottom")

```

#### Low-dimensional representation of SAMPLES

```{r}
tab_feat_obs_oj <- res_count_oj$metafeature_aggregate %>%
  as.data.frame()%>%
  rename(JuiceID = subID) %>%
  mutate(JuiceID = as.integer(JuiceID)) %>%
  left_join(.,metauni)

reshape_feat_obs_oj <- reshape(tab_feat_obs_oj,
                            idvar = c("JuiceID", "timepoint"),
                            v.names = c("value"),
                            timevar = "PC",
                            direction = "wide")
colnames(reshape_feat_obs_oj) <- sub(".*value[.]","", colnames(reshape_feat_obs_oj))
metatable_oj$timepoint <- metatable_oj$Day
reshape_feat_obs_oj <- reshape_feat_obs_oj %>% 
  left_join(., y = metatable_oj, by = c("Treatment", "Trial", "timepoint")) 


reshape_feat_obs_oj %>% 
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = pH, shape = Trial),size = 4)+
  gradient_color(c("yellow","darkred"))+
  scale_shape_manual(values = Trial_shape)+
  labs(x = "Component 1", y = "Component 2", color = "pH")+
  #geom_mark_ellipse(aes(fill = Thermal.x), alpha = 0.15, expand = unit(2, "mm"))+ 
  #scale_fill_manual(values = Thermal_color)+
  theme_pubr()
  #theme(plot.margin = margin(2, 2, 2, 2, "cm"))+
  #scale_x_continuous(limits = c(-10,22))+
  #scale_y_continuous(limits = c(-22,24))

```

This plot below shows that we cannot distinguish spoiled vs not spoiled,
or shelf-life stage based on microbiome

```{r}
reshape_feat_obs_oj %>% 
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = APDA, shape = Thermal.x),size = 4)+ 
  gradient_color(c("skyblue","black"))+
  labs(x = "Component 2", y = "Component 3", color = "APDA (Log10 CFU/mL)", shape = "Treatment")+
  geom_mark_ellipse(aes(fill = Shelf_Life_Stage), 
                    alpha = 0.15, expand = unit(1, "mm"))+ theme_pubr()+
  scale_fill_manual(values = Stage_color)+
  theme(plot.margin = margin(2, 2, 2, 2, "cm"))+
  scale_x_continuous(limits = c(-20,24))+
  scale_y_continuous(limits = c(-22,24))
```

Trajectory of Top features Component 1
```{r}
# Extract feature loadings from TEMPTED output
f_loadings_oj <- data.frame(res_count_oj$B_hat)

# Identify ASVs whose absolute values of loadings are in the top 10%
top_abs_PC1_oj <- f_loadings_oj[(abs(f_loadings_oj$PC1))>=quantile(abs(f_loadings_oj$PC1),probs=0.9),] %>% rownames()

top_PC1_oj_df <- f_loadings_oj[(abs(f_loadings_oj$PC1))>=quantile(abs(f_loadings_oj$PC1),probs=0.9),] 

top_abs_PC1_oj <- top_PC1_oj_df[order(top_PC1_oj_df$PC1, decreasing = TRUE),] %>% rownames()

# Go through the same steps to plot 
PERFect_physeq@tax_table[top_abs_PC1_oj][,c("Family","Genus","Species")]

top_abs_PC1_oj_labs <- c("Pichia ASV_9",
                          "Pichia ASV_15",
                          "Saccharomyces ASV_3",
                          "Clavispora ASV_16",
                          "Starmerella ASV_47",
                          "Starmerella ASV_65",
                          "Lasiodiplodia ASV_4",
                          "Penicillium ASV_29",
                          "Pichia ASV_48",
                          "Lasiodiplodia ASV_1",
                          "Colletotrichum ASV_38")
names(top_abs_PC1_oj_labs) <- top_abs_PC1_oj
plot_feature_summary(proportion_table_oj[,top_abs_PC1_oj], 
                     metatable_oj$Day, 
                     metatable_oj$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life",
       y="Relative Abundance")+
    scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC1_oj_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()
```
Trajectory of Top features Component 2
```{r}
top_PC2_oj_df <- f_loadings_oj[(abs(f_loadings_oj$PC2))>=quantile(abs(f_loadings_oj$PC2),probs=0.9),] 

top_abs_PC2_oj <- top_PC2_oj_df[order(top_PC2_oj_df$PC2, decreasing = TRUE),] %>% rownames()

PERFect_physeq@tax_table[top_abs_PC2_oj][,c("Family","Genus","Species")]
top_abs_PC2_oj_labs <- 
  c("Alternaria ASV_51","Eremothecium ASV_85","Diaporthe ASV_59","Botrytis ASV_62","Lasiodiplodia ASV_40", "Fusarium ASV_75", "unclassified \n Didymellaceae ASV_103","Alternaria ASV_132","Lasiodiplodia ASV_4", "Pichia ASV_45","Candida ASV_5")

names(top_abs_PC2_oj_labs) <- top_abs_PC2_oj
tab_sel_feat_oj_PC2 <- cbind(proportion_table_oj[,top_abs_PC2_oj], metatable_oj)

tab_sel_feat_oj_PC2 <- reshape(tab_sel_feat_oj_PC2, 
                        varying=list(top_abs_PC2_oj), 
                        times=top_abs_PC2_oj, 
                        timevar="feature", 
                        v.names="RA", 
                        ids=rownames(tab_sel_feat_oj_PC2),
                        direction="long")

  ggplot(data=tab_sel_feat_oj_PC2) + 
  geom_point(aes(x=Day, y=RA, color = Trial, shape = Spoilage), 
             size = 3) +
  facet_wrap(vars(feature),  
             labeller = labeller(feature = top_abs_PC2_oj_labs))+ scale_color_manual(values = Trial_color) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+  
  coord_trans(y="sqrt")+
  theme_pubr()
# summary plot
plot_feature_summary(proportion_table_oj[,top_abs_PC2_oj], 
                     metatable_oj$Day, 
                     metatable_oj$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+
  scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC2_oj_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()

```

Trajectory of Top features Component 3

```{r}
top_PC3_oj_df <- f_loadings_oj[(abs(f_loadings_oj$PC3))>=quantile(abs(f_loadings_oj$PC3),probs=0.9),] 

top_abs_PC3_oj <- top_PC3_oj_df[order(top_PC3_oj_df$PC3, decreasing = TRUE),] %>% rownames()

PERFect_physeq@tax_table[top_abs_PC3_oj][,c("Family","Genus","Species")]
top_abs_PC3_oj_labs <- 
  c("Penicillium ASV_29","Pichia ASV_26","Cladosporium ASV_24","Colletotrichum ASV_38","Lasiodiplodia ASV_1", "Starmerella ASV_47", "Pichia ASV_15","Pichia ASV_9", "Lasiodiplodia ASV_60", "Kazachstania ASV_252","Saccharomyces ASV_3")

names(top_abs_PC3_oj_labs) <- top_abs_PC3_oj
tab_sel_feat_oj_PC3 <- cbind(proportion_table_oj[,top_abs_PC3_oj], metatable_oj)

tab_sel_feat_oj_PC3 <- reshape(tab_sel_feat_oj_PC3, 
                        varying=list(top_abs_PC3_oj), 
                        times=top_abs_PC3_oj, 
                        timevar="feature", 
                        v.names="RA", 
                        ids=rownames(tab_sel_feat_oj_PC3),
                        direction="long")

ggplot(data=tab_sel_feat_oj_PC3) + 
  geom_point(aes(x=Day, y=RA, color = Trial, 
                 shape = Spoilage), 
             size = 3) +
  facet_wrap(vars(feature),  
             labeller = labeller(feature = top_abs_PC3_oj_labs))+ scale_color_manual(values = Trial_color) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+  
  coord_trans(y="sqrt")+
  theme_pubr()
# summary plot
plot_feature_summary(proportion_table_oj[,top_abs_PC3_oj], 
                     metatable_oj$Day, 
                     metatable_oj$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+
  scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC3_oj_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()

plot_feature_summary(proportion_table_oj[,top_abs_PC3_oj], 
                     metatable_oj$Day, 
                     metatable_oj$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+
  scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC3_oj_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()


```
This code below plots the summary plot of a single or a few ASV
```{r}
plot_feature_summary(proportion_table_oj %>% 
                       select(ASV_3, ASV_15, ASV_48), 
                     metatable_oj$Day, 
                     metatable_oj$Treatment, 
                     bws=30, nrow = 3) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+
  scale_fill_manual(values = Treatment_color)+
  scale_color_manual(values = Treatment_color)+
  facet_wrap(vars(feature_all), nrow = 3, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC1_oj_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()

```
### Cider data set

```{r}
# Prepare input for TEMPTED. Easy if the steps were done on OJ dataset first
metatable_cd <- metatable %>% filter(Beverage == "Cider")

```

```{r}
# Remove Subjects with just one time point: 25 and 28

counttable_cd <- counttable[rownames(metatable_cd),]
table(rownames(counttable_cd) == rownames(metatable_cd))
res_count_cd <- tempted::tempted_all(counttable_cd,
                                  metatable_cd$Day,
                                  metatable_cd$JuiceID,
                                  #settings used in the tutorial
                                  threshold = 0.95,
                                  transform = "clr",
                                  pseudo = 0.5,
                                  r = 3,
                                  smooth = 1e-5,
                                  pct_ratio = 0.1,
                                  pct_aggregate = 1)
#[output]
#Calculate the 1th Component
#Convergence reached at dif=3.66159484042976e-05, iter=5
#Calculate the 2th Component
#Convergence reached at dif=7.75021715802552e-05, iter=5
#Calculate the 3th Component
#Convergence reached at dif=4.37191441912897e-05, iter=9

```

#### Low-dimensional representation of SUBJECTS

```{r}
# Create a data frame for plotting samples on a 2D space
A_data_cd <- metauni %>% dplyr::filter(!(JuiceID %in% c(25,28))) %>% filter(Beverage == "Cider")

rownames(A_data_cd) <- A_data_cd$JuiceID

# Subject loadings are stored in A_hat (stored in res_count)
A_data_cd <- cbind(res_count_cd$A_hat[rownames(A_data_cd),],A_data_cd)

# Plot of subject loading
p_cd <- A_data_cd %>% 
  ggplot(aes(x = A_data_cd$PC1, y = A_data_cd$PC2))+
  geom_point(aes(shape = Thermal, color = Treatment), 
             size = 4)+ labs(x = "Component 1", y = "Component 2",
                                     title = "Subject loadings")+
  scale_color_manual(values = Treatment_color)
p_cd + geom_mark_ellipse(aes(fill = Trial), expand = unit(3, "mm"))+
scale_fill_manual(values = Trial_color)+
  scale_y_continuous(limits = c(-0.4,0.8))+
  scale_x_continuous(limits = c(-0.4,0.6))+
  theme_classic()
```

Clearly, the beta diversity is driven by Trial, i.e. the source of the
juice.Unlike in orange juice, cider samples don't seem to form thermal Vs non-thermal clusters.

```{r}
# Plot of subject loading
p_cd2 <- A_data_cd %>% ggplot(aes(x = A_data_cd$PC1, y = A_data_cd$PC2))+
  geom_point(aes(shape = Thermal, color = Treatment), size = 4)+ 
  labs(x = "Component 1", 
       y = "Component 2",
       title = "Subject loadings")+
  scale_color_manual(values = Treatment_color)

p_cd2 + geom_mark_ellipse(aes(fill = Thermal), alpha = 0.15,
                          expand = unit(0, "mm"))+
  scale_fill_manual(values = Thermal_color)+
  scale_y_continuous(limits = c(-0.4,0.8))+
  scale_x_continuous(limits = c(-0.6,0.6))+
  theme_classic()
  
```

```{r}
p_cd_min1 <- A_data_cd %>% 
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = Trial), size = 4)+
  labs(x = "Component 1", y = "Component 2",
  title = "Subject loadings \n colored by Trial")+
  scale_color_manual(values = Trial_color)+
  theme_pubr()

p_cd_min2 <- A_data_cd %>% 
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = Trial), size = 4)+
  labs(x = "Component 2", y = "Component 3",
  title = "Subject loadings \n colored by Trial")+
  scale_color_manual(values = Trial_color)+
  theme_pubr()
  

p_cd_min3 <- A_data_cd %>% 
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = Tech), size = 4)+
  labs(x = "Component 2", y = "Component 3",
  title = "Subject loadings \n colored by Technology")+
  scale_color_manual(values = Tech_color)+
  theme_pubr()
ggarrange(p_cd_min1, p_cd_min2, legend = "bottom")

```
#### Temporal loadings

```{r}
# Temporal loadings are stored in Phi_hat in res_count
tempted::plot_time_loading(res_count_cd, r = 3)+
  geom_line(linewidth = 2)+
  scale_color_brewer(type = "qual")+
  labs(title = "Temporal Loadings", x = "Time in shelf-life (Days)")+
  theme_pubr()

```

#### Feature (ASV) loadings

```{r}
# Feature loadings are stored in B_hat in res_count
res_count_cd$B_hat %>% as.data.frame() %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point() + 
  labs(x = "Component 1", y = "Component 2", title = "Feature loading")+
  theme_pubr()

res_count_cd$B_hat %>% as.data.frame() %>%
  ggplot(aes(x = PC2, y = PC3))+
  geom_point() + 
  labs(x = "Component 1", y = "Component 2", title = "Feature loading")+
  theme_pubr()
```

#### Log ratio of top features

```{r}
# Log ratios are stored in metafeature_ration in res_count
# For grouping variable, subset the JuiceID, a desired column
tempted::plot_metafeature(res_count_cd$metafeature_ratio, 
                          metauni[,c(1,4)],nrow = 2) + 
  geom_line(color = "black")+
  xlab("Days in shelf-life")+theme_pubr()+
  scale_color_manual(values = Trial_color, name = "Treatment")+
  scale_fill_manual(values = Trial_color, name = "Treatment")
```

#### Subject trajectories

```{r}
# Subject trajectories are stored in metafeature_aggregate in res_count
tempted::plot_metafeature(res_count_cd$metafeature_aggregate, metauni[,c(1,6)],nrow = 2)+
  xlab("Days in shelf-life")+theme_pubr()+
  scale_fill_manual(values = Tech_color, name = "Treatment")+
  scale_color_manual(values = Tech_color, name = "Treatment")

```

#### Low-dimensional representation of SAMPLES

```{r}
tab_feat_obs_cd <- res_count_cd$metafeature_aggregate %>%
  as.data.frame()%>%
  rename(JuiceID = subID) %>%
  mutate(JuiceID = as.integer(JuiceID)) %>%
  left_join(.,metauni)

reshape_feat_obs_cd <- reshape(tab_feat_obs_cd,
                            idvar = c("JuiceID", "timepoint"),
                            v.names = c("value"),
                            timevar = "PC",
                            direction = "wide")
colnames(reshape_feat_obs_cd) <- sub(".*value[.]","", colnames(reshape_feat_obs_cd))
metatable_cd$timepoint <- metatable_cd$Day
reshape_feat_obs_cd <- reshape_feat_obs_cd %>% 
  left_join(., y = metatable_cd, by = c("Treatment", "Trial", "timepoint")) 


reshape_feat_obs_cd %>% 
  ggplot(aes(x = PC2, y = PC3))+
  geom_point(aes(color = Thermal.x), size = 4)+
  labs(x = "Component 2", y = "Component 3", color = "Treatment")+
  scale_color_manual(values = Thermal_color)+
  theme_pubr()

```

This plot below shows that we cannot distinguish spoiled vs not spoiled

```{r}
reshape_feat_obs_cd %>% 
  filter(Shelf_Life_Stage == "End") %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = Spoilage, shape = Thermal.x),size = 4)+ 
  scale_color_manual(values = Spoiled_color)+
  labs(x = "Component 1", y = "Component 2", color = "Spoiled?", shape = "Treatment")+
  geom_mark_ellipse(aes(fill = Spoilage), 
                    alpha = 0.15, expand = unit(1, "mm"))+
  scale_fill_manual(values = Spoiled_color)+
  theme_classic()+
  theme(plot.margin = margin(2, 2, 2, 2, "cm"))+
  scale_x_continuous(limits = c(-22,22))+
  scale_y_continuous(limits = c(-10,22))
```

Trajectory of Top features Component 3

```{r}

proportion_table_cd <- counttable_cd/rowSums(counttable_cd)

# Extract feature loadings from TEMPTED output
f_loadings_cd <- data.frame(res_count_cd$B_hat)

# Identify ASVs whose absolute values of loadings are in the top 10%
top_abs_PC3_cd <- f_loadings_cd[(abs(f_loadings_cd$PC3))>=quantile(abs(f_loadings_cd$PC3),probs=0.9),] %>% rownames()

top_PC3_cd_df <- f_loadings_cd[(abs(f_loadings_cd$PC3))>=quantile(abs(f_loadings_cd$PC3),probs=0.9),] 

top_abs_PC3_cd <- top_PC3_cd_df[order(top_PC3_cd_df$PC3, decreasing = TRUE),] %>% rownames()


#top_ASVs_PC3_cd <- res_count_cd$toppct_ratio %>% as.data.frame() %>% filter(PC3 == TRUE) %>% rownames()

PERFect_physeq@tax_table[top_abs_PC3_cd][,c("Family","Genus","Species")]
top_abs_PC3_cd_labs <- c("Cladosporium ASV_24",
                       "Cladosporium ASV_79",
                       "Cladosporium ASV_71",
                       "Cystofilobasidium ASV_99",
                       "Candida ASV_138",
                       "Pichia ASV_84",
                       "Kregervanrija ASV_172",
                       "Mrakia ASV_205",
                       "Mrakia ASV_139",
                       "Hanseniaspora ASV_231",
                       "Saturnispora ASV_88",
                       "Alternaria ASV_55",
                       "Candida ASV_11")
names(top_abs_PC3_cd_labs) <- top_abs_PC3_cd
tab_sel_feat_cd <- cbind(proportion_table_cd[,top_abs_PC3_cd], metatable_cd)
tab_sel_feat_cd <- reshape(tab_sel_feat_cd, 
                        varying=list(top_abs_PC3_cd), 
                        times=top_abs_PC3_cd, 
                        timevar="feature", 
                        v.names="RA", 
                        ids=rownames(tab_sel_feat_cd),
                        direction="long")
p_topfeat_cd <- ggplot(data=tab_sel_feat_cd) + 
  geom_point(aes(x=Day, y=RA, color=Thermal, shape = Trial), alpha = 0.75,
             size = 3) +
  facet_wrap(vars(feature),  labeller = labeller(feature = top_abs_PC3_cd_labs), nrow = 4)+ scale_color_manual(values = Thermal_color) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+  
  coord_trans(y="sqrt")+theme_pubr()
# summary plot
p_topfeat_summary_cd_PC3 <- plot_feature_summary(proportion_table_cd[,top_abs_PC3_cd], 
                     metatable_cd$Day, 
                     metatable_cd$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life",
       y="Relative Abundance")+
    scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC3_cd_labs))+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()

```
Trajectory of Top features Component 2

```{r}
proportion_table_cd <- counttable_cd/rowSums(counttable_cd)

top_abs_PC2_cd <- f_loadings_cd[(abs(f_loadings_cd$PC2))>=quantile(abs(f_loadings_cd$PC2),probs=0.9),] %>% rownames()

top_PC2_cd_df <- f_loadings_cd[(abs(f_loadings_cd$PC2))>=quantile(abs(f_loadings_cd$PC2),probs=0.9),] 

top_abs_PC2_cd <- top_PC2_cd_df[order(top_PC2_cd_df$PC2, decreasing = TRUE),] %>% rownames()

#top_ASVs_PC2_cd <- res_count_cd$toppct_ratio %>% as.data.frame() %>% filter(PC2 == TRUE) %>% rownames()

PERFect_physeq@tax_table[top_abs_PC2_cd][,c("Family","Genus","Species")]
top_abs_PC2_cd_labs <- 
c("unclassified \n Saccharomycetales ASV_33",
  "Pichia ASV_28",
  "Kurtzmaniella ASV_36",
  "Chaetocapnodium ASV_61",
  "Didymella ASV_68",
  "unclassified \n Saccharomycetales ASV_13",
  "Aureobasidium ASV_89",
  "Bulleromyces ASV_73",
  "Cladosporium ASV_24",
  "Zygosaccharomyces ASV_128",
  "Stemphylium ASV_124",
  "Aspergillus ASV_173",
  "Acremonium ASV_100")
names(top_abs_PC2_cd_labs) <- top_abs_PC2_cd
tab_sel_feat_cd_PC2 <- cbind(proportion_table_cd[,top_abs_PC2_cd], metatable_cd)
tab_sel_feat_cd_PC2 <- reshape(tab_sel_feat_cd_PC2, 
                        varying=list(top_abs_PC2_cd), 
                        times=top_abs_PC2_cd, 
                        timevar="feature", 
                        v.names="RA", 
                        ids=rownames(tab_sel_feat_cd_PC2),
                        direction="long")
p_topfeat_cd_PC2 <- ggplot(data=tab_sel_feat_cd_PC2) + 
  geom_point(aes(x=Day, y=RA, color=Thermal, shape = Trial), alpha = 0.75,
             size = 3) +
  facet_wrap(vars(feature),  labeller = labeller(feature = top_abs_PC2_cd_labs), nrow = 4)+ scale_color_manual(values = Thermal_color) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+  
  coord_trans(y="sqrt")+theme_pubr()
# summary plot

p_topfeat_summary_cd_PC2 <- plot_feature_summary(proportion_table_cd[,top_abs_PC2_cd], 
                     metatable_cd$Day, 
                     metatable_cd$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life",
       y="Relative Abundance")+
    scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y", labeller = 
               labeller(feature_all = top_abs_PC2_cd_labs))+
  guides(color = guide_legend(title = "Trial"),
         fill = guide_legend(title = "Trial"))+
  theme_pubr()

```
Trajectory of Top features Component 1

```{r}
#top_ASVs_cd_PC1 <- res_count_cd$toppct_ratio %>% as.data.frame() %>% filter(PC1 == TRUE) %>% rownames()

top_abs_PC1_cd <- f_loadings_cd[(abs(f_loadings_cd$PC1))>=quantile(abs(f_loadings_cd$PC1),probs=0.9),] %>% rownames()

top_PC1_cd_df <- f_loadings_cd[(abs(f_loadings_cd$PC1))>=quantile(abs(f_loadings_cd$PC1),probs=0.9),] 

top_abs_cd_PC1 <- top_PC1_cd_df[order(top_PC1_cd_df$PC1, decreasing = TRUE),] %>% rownames()

PERFect_physeq@tax_table[top_abs_cd_PC1][,c("Family","Genus","Species")]
top_abs_PC1_cd_labs <- c("Mrakia ASV_23",
                         "Mrakia ASV_42",
                         "Mrakia ASV_34",
                         "Cystofilobasidium ASV_58",
                         "Acremonium ASV_100",
                         "Penicillium ASV_54",
                         "Pichia ASV_50",
                         "Cladosporium ASV_20",
                         "Penicillium ASV_30",
                         "Pichia ASV_8",
                         "Pichia ASV_28",
                         "Cladosporium ASV_24",
                         "Pichia ASV_35")
   
names(top_abs_PC1_cd_labs) <- top_abs_cd_PC1
tab_sel_feat_cd_PC1 <- cbind(proportion_table_cd[,top_abs_cd_PC1], metatable_cd)
tab_sel_feat_cd_PC1 <- reshape(tab_sel_feat_cd_PC1, 
                        varying=list(top_abs_cd_PC1), 
                        times=top_abs_cd_PC1, 
                        timevar="feature", 
                        v.names="RA", 
                        ids=rownames(tab_sel_feat_cd_PC1),
                        direction="long")
p_topfeat_cd_PC1 <- ggplot(data=tab_sel_feat_cd_PC1) + 
  geom_point(aes(x=Day, y=RA, color=Thermal, shape = Spoilage), alpha = 0.75, size = 3) +
  facet_wrap(vars(feature), labeller = labeller(feature = top_abs_PC1_cd_labs))+ #gradient_color("OrRd")+
  scale_color_manual(values = Thermal_color)+
  labs(x="Day of Shelf-Life", y="Relative Abundance")+  
  coord_trans(y="sqrt")+theme_pubr()

# summary plot

p_topfeat_summary_cd_PC1 <- plot_feature_summary(proportion_table_cd[,top_abs_cd_PC1], 
                     metatable_cd$Day, 
                     metatable_cd$Tech, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life", y="Relative Abundance")+
  guides(color = guide_legend(title = "Tech"),
         fill = guide_legend(title = "Tech")) +
  scale_fill_manual(values = Tech_color)+
  scale_color_manual(values = Tech_color)+
  facet_grid(labeller = top_abs_PC1_cd_labs)+
  facet_wrap(vars(feature_all), scales = "free_y", labeller = labeller(feature_all = top_abs_PC1_cd_labs))+
  theme_pubr()

```
How to identify top ASVs ranked by the absolute value of feature loadings
```{r}
# Extract feature loadings from TEMPTED output
f_loadings_cd <- data.frame(res_count_cd$B_hat)

# Identify ASVs whose absolute values of loadings are in the top 10%
top_abs_PC1_cd <- f_loadings_cd[(abs(f_loadings_cd$PC1))>=quantile(abs(f_loadings_cd$PC1),probs=0.9),] %>% rownames()

# Go through the same steps to plot 
PERFect_physeq@tax_table[top_abs_PC1_cd][,c("Family","Genus","Species")]
plot_feature_summary(proportion_table_cd[,top_abs_PC1_cd], 
                     metatable_cd$Day, 
                     metatable_cd$Thermal, 
                     bws=30, nrow = 4) + 
  labs(x="Day of Shelf-Life",
       y="Relative Abundance")+
    scale_fill_manual(values = Thermal_color)+
  scale_color_manual(values = Thermal_color)+
  facet_wrap(vars(feature_all), nrow = 4, 
             scales = "free_y")+
  guides(color = guide_legend(title = "Treatment"),
         fill = guide_legend(title = "Treatment"))+
  theme_pubr()

```
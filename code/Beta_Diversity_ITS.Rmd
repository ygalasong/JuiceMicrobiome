---
title: "Beta_Diversity_ITS"
author: "Yupawadee Galasong"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Load packages
```{r}
library(zCompositions)
library(phyloseq)
library(tidyverse)
library(ggpubr)
library(vegan)
library(microbiome)
library(tempted)
```

### Set up color & shape preferences - Metadata variables
Useful palette generator <https://coolors.co/>
Make sure it is friendly to color blind readers.
<https://www.datylon.com/blog/data-visualization-for-colorblind-readers#:~:text=The%20first%20rule%20of%20making,out%20of%20these%20two%20hues.>
Example of how to use color and shape preferences in ggplot
`ggplot(data = final_physeq@sam_data, aes(x = malic, y = fructose))+geom_point(aes(color = Trial, shape = Trial))+scale_color_manual(values = Trial_color)+scale_shape_manual(values = Trial_shape)`
```{r}
# Specify colors
Trial_color <- c("#fcd0a1","#b1b695","#A690A4")
# Specify which trial each color is for
names(Trial_color) <- c(1,2,3)

Trial_shape <- c(15,16,17)
names(Trial_shape) <- c(1,2,3)

Beverage_color <- c("#FFC759","#FF7B9C")
names(Beverage_color) <- c("Orange Juice","Cider")

Beverage_shape <- c(18,19)
names(Beverage_shape) <- c("Orange Juice","Cider")

Treatment_color <- c("#332288", "#882255", "#AA4499", "#CC6677", "#DDCC77", 
                     "#44AA99", "#117733")
names(Treatment_color) <- c("No Treatment", "Pasteurization", 
                           "Pasteurization + SB + PS","Pasteurization + DMDC + NG",
                           "UV","HPP","HPP + DMDC + NG")
Stage_color <- c("#7CA1CC", "#3D65A5", "#1F449C")
names(Stage_color) <- c("Beginning", "Day14", "End")

Stage_shape <- c(15,16,17)
names(Stage_shape) <- c("Beginning", "Day14", "End")

Spoiled_color <- c("#E08E45", "#6B2737")
names(Spoiled_color) <- c("Not spoiled", "Spoiled")

Thermal_color <- c("#EB4511","#1C3144","#FFBA08")
names(Thermal_color) <- c("Thermal", "Non-thermal", "No Treatment")
```
### Set up color & shape preferences - Taxanomical ranks
```{r}


```

## Microbiome data is compositional.
1. Microbiome Datasets Are Compositional: And This Is Not Optional
<https://doi.org/10.3389/fmicb.2017.02224>
2. A Novel Sparse Compositional Technique Reveals Microbial Perturbations
(robust Aitchison PCA)
<https://doi.org/10.1128/msystems.00016-19>
3. Time-Informed Dimensionality Reduction for Longitudinal Microbiome Studies
<https://doi.org/10.1101/2023.07.26.550749>

### Computational approach for compositional data
Note: the code in the next four chunks won't be run. It is only for showing the workflow
using popular packages. For this project, we will use a rather novel method implemented in
`tempted` package.
####  Imputation of zeros, left-censored and missing data in compositional data 
```{r}
#zCompostionsR::

```

#### Centered log-ration (CLR) transformation
```{r}
#clr <- microbiome::transform(final_physeq, "clr")
#otu_table(clr)[1:5,1:5]
```

#### Aitchison distance
Aitchison distance is basically the Euclidean distances between CLR-transformed 
sample abundance vectors.
```{r}
#aitchison <- vegan::vegdist(clr, method = "euclidean")

# Are results the same?
#aitchison2 <- phyloseq::distance(clr, method = "euclidean")
```

#### Variance-based compositional principal component analysis (PCA) 
```{r}
## while the method is specified as rda (short for Redundancy Analysis),
## not specifying the 'formula' argument means we are running an unconstrained RDA,
## which is equivalent to running PCA.
# pca_clr <- phyloseq::ordinate(clr, method = "RDA", distance = aitchison2)
```

### TEMPoral TEnsor Decomposition (TEMPTED)
The goal of TEMPTED is to perform dimensionality reduction for multivariate longitudinal data, with a special attention to longitudinal microbiome studies.

#### Load the data and modify to the format required by 'tempted' package
```{r}
# load("/local/workdir/yg225/JuiceMicrobiome/Data_ITS/metadata.RData")
# load("/local/workdir/yg225/JuiceMicrobiome/Data_ITS/final_physeq.RData")

# A data.frame with rows representing samples and matching with data.frame count table and processed table
## Create a unique ID for each (juice, treatment) combination
ID_df <- metatable %>% expand(Beverage, Treatment, Trial) %>% 
  mutate(JuiceID = seq(from = 1, to = nrow(.)))

metatable <- metadata %>% 
  # remove irrelevant columns
  dplyr::select(-c("is.neg","Sample_or_Control")) %>% 
  # Assign JuiceID to each entry
  left_join(., y = ID_df,) %>%
  # Change row names to sample names
  column_to_rownames(var = "Assemblage")

# A data.frame with rows representing samples and matching with data.frame metatable and columns representing microbial features (i.e. OTUs). Each entry is a read count.

counttable <- final_physeq@otu_table %>% t() %>% as.data.frame() 

# Check if rows match and display the number of matches which should equal the number of samples
table(rownames(counttable) == rownames(metatable))

# A variable storing ID and Treatment
metauni <- unique(metatable[,c("JuiceID","Beverage","Treatment","Trial","Thermal")])
```

#### Run TEMPTED for Microbiome Count Data
Following github tutorial <https://github.com/pixushi/tempted?tab=readme-ov-file>
```{r}
# Remove subject with only 1 time point to avoid error
# An error earlier indicated that JuiceID 25 and 28 must be removed
# Get sample name (ITSXXX) corresponding to JuiceID 25 and 28
to_rm <- metatable %>% dplyr::filter(JuiceID %in% c(25,28)) %>% rownames()

# Remove JuiceID 25 and 28 from metatable
metatable <- metatable %>% dplyr::filter(!(rownames(.)%in% to_rm))
  
# Remove samples in to_rm from the count table
counttable <- counttable[!(rownames(counttable) %in% to_rm),]
res_count <- tempted::tempted_all(counttable,
                                  metatable$Day,
                                  metatable$JuiceID,
                                  #settings used in the tutorial
                                  threshold = 0.95,
                                  transform = "clr",
                                  pseudo = 0.5,
                                  r = 2,
                                  smooth = 1e-5,
                                  pct_ratio = 0.1,
                                  pct_aggregate = 1)

```
#### Low-dimensional representation of subjects
```{r}
# Create a data frame for plotting samples on a 2D space
A_data <- metauni %>% dplyr::filter(!(rownames(.) %in% to_rm))
rownames(A_data) <- A_data$JuiceID

# Subject loadings are stored in A_hat (stored in res_count)
A_data <- cbind(res_count$A_hat[rownames(A_data),],A_data)

# Plot of subject loading
A_data %>% ggplot(aes(x = A_data$PC1, y = A_data$PC2, color = Trial))+
  geom_point(aes(shape = Beverage), size = 4)+ labs(x = "Component 1", 
                                     y = "Component 2",
                                     title = "Subject loadings")+
  scale_color_manual(values = Trial_color)+
  scale_shape_manual(values = Beverage_shape) + theme_classic()
```

Clearly, the beta diversity is driven by Trial, i.e. the source of the juice.
Individual treatments did not form clear cluster. See the plot below.
```{r}
# Plot of subject loading
A_data %>% ggplot(aes(x = A_data$PC1, y = A_data$PC2, color = Treatment))+
  geom_point(aes(shape = Beverage), size = 4)+ labs(x = "Component 1", 
                                     y = "Component 2",
                                     title = "Subject loadings")+
  scale_color_manual(values = Treatment_color)+
  scale_shape_manual(values = Beverage_shape) + theme_classic()

```

Let's group the treatment by "Thermal" variable
```{r}
A_data %>% 
  #filter(Beverage == "Cider") %>%
  ggplot(aes(x = PC1, y = PC2, color = Thermal))+
  geom_point(aes(shape = Beverage), size = 4)+ labs(x = "Component 1", 
                                     y = "Component 2",
                                     title = "Subject loadings")+
  scale_color_manual(values = Thermal_color)+
  scale_shape_manual(values = Beverage_shape) + theme_classic()

```
#### Temporal loadings
```{r}
# Temporal loadings are stored in Phi_hat in res_count
tempted::plot_time_loading(res_count, r = 2)+
  geom_line(size = 2)+
  labs(title = "Temporal Loadings", x = "Time in shelf-life (Days)")+
  theme_classic()


```

#### Feature (ASV) loadings
```{r}
# Feature loadings are stored in B_hat in res_count
res_count$B_hat %>% as.data.frame() %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point() + 
  labs(x = "Component 1", y = "Component 2", title = "Feature loading")+
  theme_classic()

```

#### Log ratio of top features
```{r}
# Log ratios are stored in metafeature_ration in res_count
# For grouping variable, subset the JuiceID, a desired column
tempted::plot_metafeature(res_count$metafeature_ratio, metauni[,c(1,2)]) + 
  xlab("Days in shelf-life")+theme_classic()

```
#### Subject trajectories
```{r}
# Subject trajectories are stored in metafeature_aggregate in res_count
tempted::plot_metafeature(res_count$metafeature_aggregate, metauni[,c(1,5)])+
  xlab("Days in shelf-life")+theme_classic()+
  scale_fill_manual(values = Thermal_color)+
  scale_color_manual(values = Thermal_color)

```
#### Low-dimensional representation of samples
```{r}
tab_feat_obs <- res_count$metafeature_aggregate %>%
  as.data.frame()%>%
  rename(JuiceID = subID) %>%
  mutate(JuiceID = as.integer(JuiceID)) %>%
  left_join(.,metauni)

reshape_feat_obs <- reshape(tab_feat_obs,
                            idvar = c("JuiceID", "timepoint"),
                            v.names = c("value"),
                            timevar = "PC",
                            direction = "wide")
colnames(reshape_feat_obs) <- sub(".*value[.]","", colnames(reshape_feat_obs))

reshape_feat_obs %>% 
  filter(Beverage == "Orange Juice") %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint,shape = Thermal))+
  geom_point(size = 2)+ gradient_color("RdYlBu")+
  labs(x = "Component 1", y = "Component 2", color = "Days", title = "Orange Juice")+
  theme_classic()

reshape_feat_obs %>% 
  filter(Beverage == "Cider") %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = timepoint,shape = Thermal),size = 2)+ gradient_color("RdYlBu")+
  labs(x = "Component 1", y = "Component 2", color = "Days")+
  geom_mark_ellipse(aes(fill = Trial), expand = unit(2, "mm"))+ 
  theme_classic()+
  #theme(plot.margin = margin(2, 2, 2, 2, "cm"))+
  scale_x_continuous(limits = c(-10,22))+
  scale_y_continuous(limits = c(-22,24))

reshape_feat_obs %>% 
  filter(Beverage == "Orange Juice") %>%
  ggplot(aes(x = PC1, y = PC2))+
  geom_point(aes(color = timepoint,shape = Thermal),size = 2)+ gradient_color("RdYlBu")+
  labs(x = "Component 1", y = "Component 2", color = "Days")+
  geom_mark_ellipse(aes(fill = Trial), expand = unit(2, "mm"))+ 
  theme_classic()+
  #theme(plot.margin = margin(2, 2, 2, 2, "cm"))+
  scale_x_continuous(limits = c(-10,22))+
  scale_y_continuous(limits = c(-22,24))
```
We finished with TEMPTED tutorials!